# **AibolitCare API ✱**

A powerful backend system for managing medical schedules, implemented using **FastAPI**, **gRPC**, and a clean service-layer architecture. This project supports REST and gRPC APIs, with strong typing, logging, and containerization.

---

## **Table of Contents**

- ✱ [Features](#features)
    
- ✱ [Tech Stack](#tech- stack)
	
-  ✱ [Structure](#structure)
	
-  ✱ [Setup](#setup)
    
- ✱ [Usage](#usage)
	
- ✱ [JUST commands](#just-commands)
	
- ✱ [API Overview](#api-overview)
    
- ✱ [gRPC Services](#grpc-services)
    
- ✱ [Code Generation](#code-generation)
    
- ✱ [Testing & Linting](#testing--linting)
    
- ✱ [Logging](#logging)

---

## **Features**

- Dual interface: **REST** and **gRPC**
    
- Modular service-layer architecture
    
- Auto-generated Pydantic models from OpenAPI spec
    
- Auto-generated gRPC code via `protoc`
    
- Structured logging with `X-TRACE-ID`, User-Agent, and IP
    
- Format/lint/test automation via `just` and `uv`
    

---

## **Tech Stack**

- **FastAPI** – REST API
    
- **gRPC + Protobuf** – high-performance RPC
    
- **PostgreSQL** – relational DB
    
- **SQLAlchemy** – ORM
    
- **Pydantic v2** – validation and OpenAPI schema generation
    
- **uv** – dependency management and task running
    
- **just** – task runner
    
- **Docker** – environment orchestration
    

---

# **Structure**

```
✱
├── .dockerignore                          # Specifies files to ignore during Docker image build
├── .pre-commit-config.yaml         # Configuration for pre-commit hooks
├── alembic/                                  # DB migrations powered by Alembic
│   └── versions/                            # Migration scripts
├── alembic.ini                               # Alembic configuration
├── docker-compose.yml                # Compose file for PostgreSQL and other services
├── Dockerfile                                # Application Docker image
├── docs/                                       # OpenAPI spec & helper scripts
│   └── scripts/                  
├── justfile                                     # Dev automation commands (tests, lint, build, etc.)
├── pyproject.toml                         # Project metadata and dependency definitions
├── pyrightconfig.json                    # Type checking config (Pyright)
├── pytest.ini                                  # Pytest configuration
├── README.md                            # Project documentation
├── src/                                          # Application source code
│   └── aibolit/
│       ├── core/                               # App-level services: config, logging, DB, middleware
│       ├── main.py                           # REST app entry point
│       ├── models/                           # SQLAlchemy ORM models
│       ├── repositories/                    # Database abstraction layer
│       ├── schemas/                         # Pydantic schemas (OpenAPI,)
│       ├── services/                          # Business logic layer
│       └── transport/                        # API interfaces (REST, gRPC)
│           ├── grpc/
│           │   ├── adapters/                # Adapters between services and gRPC
│           │   ├── generated/              # Auto-generated gRPC Python code
│           │   ├── grpc_client.py
│           │   └── protos/                    # Protobuf definitions
│           └── rest/                             # FastAPI route handlers
├── tests/                                         # Test suite (unit & integration)
│   ├── grpc_service/                        # gRPC service tests
│   ├── schedules/                            # REST tests for schedules
│   └── users/                                   # REST tests for users
└── uv.lock                                       # Lockfile generated by `uv`
```
---
## **Setup**

```bash
# Clone the repository from GitHub and navigate into the project directory
git clone https://github.com/507015T/aibolitcare-backend && cd aibolitcare-backend

# Rename the .env.example file to .env to configure the environment
mv .env.example .env

# Sync all project dependencies
uv sync

# Make the main.py script executable
chmod +x src/aibolit/main.py

# Run the application (gRPC + REST API)
./src/aibolit/main.py
```

---

## **Usage**

### Start REST server

```bash
uv run uvicorn src.aibolit.main:make_app --factory
```

### Start gRPC server

```bash
uv run src/aibolit/transport/grpc/grpc_client.py
```

---

## **JUST commands**
```
Available recipes:
    default                   # Default command: list available commands
    lint                         # Run all checks: linters and formatting validation

    [app]
    api                         # Start app locally(only API)
    app                        # Start app locally
    grpc                       # Start app locally(only gRPC)

    [database]
    db                          # Run database
    db-clear                 # Stop and clear database
    db-start                  # Build and run database
    db-stop                  # Stop database

    [dependencies]
    update                   # Update project dependencies

    [generating]
    generate-grpc        # Generate Python code from .proto files for gRPC
    generate-openapi  # Generate pydantic schemas from openapi

    [linters]
    format                   # Automatically format code
    format-check         # Check formatting without modifying files
    ruff                        # Fix code using Ruff
    ruff-check              # Lint code using Ruff

    [start]
    start                       # Start app in Docker
    stop                       # Stop app in Docker
    stop-clear              # Stop and clear app container in Docker

    [testing]
    test-all-coverage    # Run all tests and calculate coverage
    test-api                  # Run E2E tests for API
    test-grpc                # Run E2E tests for gRPC
    test-utils                # Run unit tests for plan generation, time rounding, timeframe check
    tests                      # Run all tests
```
---

## **API Overview**

### REST API Endpoints

|Method|Endpoint|Description|
|---|---|---|
|POST|`/users`|Create a new user|
|POST|`/schedule`|Create a new medication schedule|
|GET|`/schedule`|Retrieve a specific schedule|
|GET|`/schedules`|Get all schedule IDs for a user|
|GET|`/next_takings`|Get next medications to take|

**Endpoint details:**

---

### `POST /users`

- **Request body**: `UserCreateRequest`
    
- **Response**: `UserCreateResponse`
    

---

### `POST /schedule`

- **Request body**: `MedicationScheduleCreateRequest`
    
- **Response**: `MedicationScheduleCreateResponse`
    

---

### `GET /schedule`

- **Query parameters**:
    
    - `schedule_id` (int) — required
        
    - `user_id` (int) — required
        
- **Response**: `MedicationSchedule`
    

---

### `GET /schedules`

- **Query parameters**:
    
    - `user_id` (int) — required
        
- **Response**: `MedicationScheduleIdsResponse`
    

---

### `GET /next_takings`

- **Query parameters**:
    
    - `user_id` (int) — required
        
- **Response**: `NextTakingsMedicationsResponse`
    

---

## **gRPC Services**

### `SchedulesService`

```proto
  rpc CreateSchedule(CreateScheduleRequest) returns (CreateScheduleResponse);
  rpc GetAllSchedules(GetAllSchedulesRequest) returns (GetAllSchedulesResponse);
  rpc GetUserSchedule(GetUserScheduleRequest) returns (MedicationSchedule);
  rpc GetUserNextTakings(GetUserNextTakingsRequest) returns (GetUserNextTakingsResponse);
```
### `UserService`

```proto
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  rpc GetUsers(GetAllUsersRequest) returns (GetAllUsersResponse);
```

---

## **Logging**

Structured JSON logging is enabled for all HTTP and gRPC interactions. Each log entry includes:

- Timestamp
    
- HTTP method and URL
    
- Status code
    
- Request and response payloads
    
- `X-TRACE-ID`
    
- User-Agent
    
- IP address
    

Example:

```json
{
  "timestamp": "2025-05-13T09:00:00Z",
  "method": "POST",
  "url": "/api/schedule",
  "status_code": 201,
  "trace_id": "abc-123-xyz",
  "request": { ... },
  "response": { ... }
}
```
✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱✱