<a href="https://507015t.github.io/aibolit-care-api/">
  <img src="https://github.com/507015T/aibolit-care-api/blob/main/docs/logo.png" alt="logo" width="500">
</a>
<br>
<b>Click on the logo or follow the link to see the API demonstration:</b> <a href="https://507015t.github.io/aibolit-care-api/">Click</a>
<br><br>
A powerful backend system for managing medical schedules, implemented using **FastAPI**, **gRPC**, and a clean service-layer architecture. This project supports REST and gRPC APIs, with strong typing, logging, and containerization.

---

## **Table of Contents**

  * [Features](#features)
  * [Tech Stack](#tech-stack)
	
  * [Structure](#structure)
  * [Requirements](#requirements)
  * [Installation](#installation)
    
  * [Usage](#usage)
	
  * [JUST commands](#just-commands)
	
  * [API Overview](#api-overview)
    
  * [gRPC Services](#grpc-services)
    
  * [Logging](#logging)

---

## **Features**

- Dual interface: **REST** and **gRPC**
    
- Modular service-layer architecture
    
- Auto-generated Pydantic models from OpenAPI spec
    
- Auto-generated gRPC code via `protoc`
    
- Structured logging with `X-TRACE-ID`, User-Agent, and IP
    
- Format/lint/test automation via `just` and `uv`
    

---

## **Tech Stack**

- **FastAPI** – REST API
    
- **gRPC + Protobuf** – high-performance RPC
    
- **PostgreSQL** – relational DB
    
- **SQLAlchemy** – ORM
    
- **Pydantic v2** – validation and OpenAPI schema generation
    
- **uv** – dependency management and task running
    
- **just** – task runner
    
- **Docker** – environment orchestration
    

---

# **Structure**

```
✱
├── .dockerignore                          # Specifies files to ignore during Docker image build
├── .pre-commit-config.yaml                # Configuration for pre-commit hooks
├── alembic/                               # DB migrations powered by Alembic
│   └── versions/                          # Migration scripts
├── alembic.ini                            # Alembic configuration
├── docker/
│   └── init-scripts/                      # Scripts for creating multiple databases during initialization
├── docker-compose.yml                     # Compose file for PostgreSQL and other services
├── Dockerfile                             # Application Docker image
├── docs/                                  # OpenAPI spec & helper scripts
│   ├── index.html                         # Documentation homepage
│   ├── logo.png                           # Logo for documentation
│   ├── openapi/                           # Convert script from json to yaml and specs
│   └── swagger-ui/                        # Swagger UI files 
├── justfile                               # Dev automation commands (tests, lint, build, etc.)
├── pyproject.toml                         # Project metadata and dependency definitions
├── pyrightconfig.json                     # Type checking config (Pyright)
├── pytest.ini                             # Pytest configuration
├── README.md                              # Project documentation
├── src/                                   # Application source code
│   └── aibolit/
│       ├── core/                          # App-level services: config, logging, DB, middleware
│       ├── grpc/
│       │   ├── adapters/                  # Adapters between services and gRPC
│       │   ├── generated/                 # Auto-generated gRPC Python code
│       │   ├── grpc_client.py
│       │   └── protos/                    # Protobuf definitions
│       ├── main.py                        # REST app entry point
│       ├── models/                        # SQLAlchemy ORM models
│       ├── repositories/                  # Database abstraction layer
│       ├── schemas/                       # Pydantic schemas (OpenAPI)
│       ├── services/                      # Business logic layer
│       └── transport/                     # API interfaces (REST, gRPC)
│           └── views/                     # FastAPI route handlers
├── tests/                                 # Test suite (unit & integration)
│   ├── grpc/                              # gRPC service tests
│   ├── schedules/                         # REST tests for schedules
│   └── users/                             # REST tests for users
└── uv.lock                                # Lockfile generated by `uv`

```
---


## **Requirements**

Before you start, make sure the following tools are installed:
* [**uv**](https://github.com/astral-sh/uv) – fast Python package manager and task runner
* [**just**](https://github.com/casey/just) – task automation
* [**Docker**](https://www.docker.com/products/docker-desktop/) – container runtime
* [**Docker Compose**](https://docs.docker.com/compose/install/) – service orchestration (v2+)

---

## **Installation**

```bash
# Clone the repository from GitHub and navigate into the project directory
git clone https://github.com/507015T/aibolit-care-api && cd aibolit-care-api

# Rename the .env.example file to .env to configure the environment
mv .env.example .env

# Sync all project dependencies
uv sync

# Very important: Install the package in editable mode using pip
uv pip install -e .

# Start the database
just db-start

# Migrate 
uv run alembic upgrade head

# Make the main.py script executable
chmod +x src/aibolit/main.py

# Run the application (gRPC + REST API)
./src/aibolit/main.py
# Alternatively, you can use the `just` command for running the app
just app
```

---

## **Usage**

### Start REST server

```bash
uv run uvicorn src.aibolit.main:make_app --factory
```

### Start gRPC server

```bash
uv run src/aibolit/transport/grpc/grpc_client.py
```

---

## **JUST commands**
```
Available recipes:
    default                   	# Default command: list available commands
    lint                        # Run all checks: linters and formatting validation

    [app]
    api                         # Start app locally (only REST)
    app                         # Start app locally (gRPC + REST)
    grpc                        # Start app locally (only gRPC)

    [database]
    db                          # Run database
    db-clear                    # Stop and clear database
    db-start                    # Build and run database
    db-stop                     # Stop database

    [dependencies]
    update                      # Update project dependencies

    [generating]
    generate-grpc               # Generate Python code from .proto files for gRPC
    generate-openapi            # Generate pydantic schemas from openapi

    [linters]
    format                      # Automatically format code
    format-check                # Check formatting without modifying files
    ruff                        # Fix code using Ruff
    ruff-check                  # Lint code using Ruff

    [start]
    start                       # Start app in Docker
    stop                        # Stop app in Docker
    stop-clear                  # Stop and clear app container in Docker

    [testing]
    test-all-coverage           # Run all tests and calculate coverage
    test-api                    # Run E2E tests for REST API
    test-grpc                   # Run E2E tests for gRPC
    test-utils                  # Run unit tests for plan generation, time rounding, timeframe check
    tests                       # Run all tests

```
***For \[testing\](except test-utils) and \[app\] require a database. Activate:***
```bash
just db-start
``` 
---

## **API Overview**

### REST API Endpoints

|Method|Endpoint|Description|
|---|---|---|
|POST|`/users`|Create a new user|
|POST|`/schedule`|Create a new medication schedule|
|GET|`/schedule`|Retrieve a specific schedule|
|GET|`/schedules`|Get all schedule IDs for a user|
|GET|`/next_takings`|Get next medications to take|

**Endpoint details:**

---

### `POST /users`

- **Request body**: `UserCreateRequest`
    
- **Response**: `UserCreateResponse`
    

---

### `POST /schedule`

- **Request body**: `MedicationScheduleCreateRequest`
    
- **Response**: `MedicationScheduleCreateResponse`
    

---

### `GET /schedule`

- **Query parameters**:
    
    - `schedule_id` (int) — required
        
    - `user_id` (int) — required
        
- **Response**: `MedicationSchedule`
    

---

### `GET /schedules`

- **Query parameters**:
    
    - `user_id` (int) — required
        
- **Response**: `MedicationScheduleIdsResponse`
    

---

### `GET /next_takings`

- **Query parameters**:
    
    - `user_id` (int) — required
        
- **Response**: `NextTakingsMedicationsResponse`
    

---

## **gRPC Services**

### `SchedulesService`

```proto
  rpc CreateSchedule(CreateScheduleRequest) returns (CreateScheduleResponse);
  rpc GetAllSchedules(GetAllSchedulesRequest) returns (GetAllSchedulesResponse);
  rpc GetUserSchedule(GetUserScheduleRequest) returns (MedicationSchedule);
  rpc GetUserNextTakings(GetUserNextTakingsRequest) returns (GetUserNextTakingsResponse);
```
### `UserService`

```proto
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  rpc GetUsers(GetAllUsersRequest) returns (GetAllUsersResponse);
```

---

## **Logging**

Structured JSON logging is enabled for all HTTP and gRPC interactions. Each log entry includes:

- Timestamp
    
- HTTP method and URL
    
- Status code
    
- Request and response payloads
    
- `X-TRACE-ID`
    
- User-Agent
    
- IP address
    

Example:

```json
{
  "timestamp": "2025-05-13T09:00:00Z",
  "method": "POST",
  "url": "/api/schedule",
  "status_code": 201,
  "trace_id": "abc-123-xyz",
  "request": {},
  "response": {}
}
```
